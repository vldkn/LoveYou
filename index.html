<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квест Любви</title>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ec407a' d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0;24,600,1,0" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');

        :root {
            --love-50: #fff5f7;
            --love-100: #ffe4ec;
            --love-200: #fecddc;
            --love-300: #fda4c0;
            --love-400: #fb719f;
            --love-500: #f04a86;
            --love-600: #ec407a;
            --love-700: #c2185b;
            --love-800: #ad1457;
            --love-900: #880e4f;
        }

        * {
            font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(1200px 600px at 20% 10%, rgba(255, 255, 255, 0.8), transparent 55%),
                        radial-gradient(900px 500px at 80% 30%, rgba(255, 228, 236, 0.9), transparent 60%),
                        linear-gradient(135deg, var(--love-50) 0%, #fde7ef 25%, #f9c1d5 55%, #f7a7c6 75%, #ffd6e2 100%);
            background-size: 140% 140%;
            animation: gradientShift 18s ease infinite;
            will-change: background-position;
        }

        /* Mobile perf: static gradient (less jank in some mobile browsers) */
        @media (max-width: 640px) {
            body {
                animation: none;
            }
            .glass {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .glass-input {
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
            }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass */
        .glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 12px 40px rgba(236, 64, 122, 0.16);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(236, 64, 122, 0.18);
            transition: none;
        }

        /* Без дополнительных эффектов при фокусе (минимализм) */
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.55);
            border-color: rgba(236, 64, 122, 0.18);
            outline: none;
            box-shadow: none;
        }

        .glass-btn {
            background: linear-gradient(135deg, rgba(236, 64, 122, 0.86), rgba(244, 143, 177, 0.86));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: none;
            transition: none;
            color: white;
        }

        .glass-btn:focus,
        .brand-chip:focus {
            outline: none;
            box-shadow: none;
        }

        /* Rounded icon badge inside buttons */
        .btn-icon-badge {
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.35);
        }

        /* Material Symbols */
        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            color: var(--love-600);
        }
        .ms-filled {
            /* Legacy helper (kept for compatibility) */
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48 !important;
        }

        /* Heart stacking: filled heart + outline heart (keeps clean silhouette) */
        .ms-fill {
            font-variation-settings: 'FILL' 1, 'wght' 350, 'GRAD' 0, 'opsz' 48 !important;
        }
        .ms-outline {
            /* Тоньше контур, чтобы не «съедал» форму */
            font-variation-settings: 'FILL' 0, 'wght' 200, 'GRAD' 0, 'opsz' 48 !important;
        }

        .hero-heart-stack {
            display: grid;
            place-items: center;
            width: fit-content;
            margin-inline: auto;
        }
        .hero-heart-stack > span {
            grid-area: 1 / 1;
        }

        /* Big heart icon (above hint/success titles) */
        .hero-heart {
            font-size: clamp(50px, 6.2vw, 64px);
            line-height: 1;
            display: block;
        }

        .heart-fill { color: var(--love-600); }
        /* Контур и заливка одного цвета */
        .heart-outline { color: var(--love-600); }

        /* Typo colors */
        .text-love { color: var(--love-800); }
        .text-love-light { color: var(--love-700); }

        /* Background hearts */
        #bgHearts {
            contain: layout paint;
            transition: opacity 320ms ease;
        }

        .floating-heart {
            position: absolute;
            opacity: 0.10;
            animation-name: floatHeart;
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            pointer-events: none;
            filter: blur(0px);
            will-change: transform;
            transform: translate3d(0, 0, 0);
        }

        @keyframes floatHeart {
            0%, 100% { transform: translate3d(0, 0, 0) rotate(var(--r, 0deg)) scale(1); }
            50% { transform: translate3d(0, -20px, 0) rotate(var(--r, 0deg)) scale(1.06); }
        }

        .heart-path { fill: rgba(236, 64, 122, 0.95); }

        /* Animations */
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(18px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .success-glow { animation: successGlow 1s ease-in-out; }
        @keyframes successGlow {
            0%, 100% { box-shadow: 0 12px 40px rgba(236, 64, 122, 0.16); }
            50% { box-shadow: 0 0 60px rgba(236, 64, 122, 0.34); }
        }

        /* Mobile: avoid animating box-shadow (can be janky) */
        @media (max-width: 640px) {
            .success-glow {
                animation: successGlowMobile 520ms ease-in-out;
            }
            @keyframes successGlowMobile {
                0%, 100% { transform: translateZ(0) scale(1); }
                50% { transform: translateZ(0) scale(1.012); }
            }
        }

        .pulse-heart { animation: pulseHeart 1.4s ease-in-out infinite; }
        @keyframes pulseHeart {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.12); }
        }

        /* Small brand chip */
        .brand-chip {
            background: rgba(255, 255, 255, 0.48);
            border: none;
        }

        /* Tutorial tooltip (first visit) */
        .tutorial-tooltip {
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translate(0, -50%);
            padding: 10px 12px;
            border-radius: 9999px;
            font-size: 12px;
            line-height: 1;
            white-space: nowrap;
            color: rgba(173, 20, 87, 0.95);

            background: rgba(255, 255, 255, 0.62);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.75);
            box-shadow: 0 10px 30px rgba(236, 64, 122, 0.18);

            opacity: 0;
            pointer-events: none;
            transition: opacity 240ms ease, transform 240ms ease;
        }

        .tutorial-tooltip.tt-visible {
            opacity: 1;
            pointer-events: auto;
            transform: translate(0, -50%);
        }

        .tutorial-tooltip.tt-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translate(8px, -50%);
        }

        .tutorial-tooltip::before {
            content: "";
            position: absolute;
            left: -7px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg);
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.62);
            border-left: 1px solid rgba(255, 255, 255, 0.75);
            border-bottom: 1px solid rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }

        /* Finale */
        .fade-out {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 320ms ease, transform 320ms ease;
        }

        #finaleScreen {
            opacity: 0;
            transition: opacity 420ms ease;
        }
        #finaleScreen.finale-visible {
            opacity: 1;
        }

        .finale-word {
            opacity: 0;
            transform: translate3d(0, 22px, 0) scale(0.98);
            font-size: clamp(46px, 9vw, 78px);
            letter-spacing: -0.02em;
            will-change: transform, opacity;
        }

        @keyframes finaleWordIn {
            0% {
                opacity: 0;
                transform: translate3d(0, 22px, 0) scale(0.98);
            }
            65% {
                opacity: 1;
                transform: translate3d(0, 0, 0) scale(1.04);
            }
            100% {
                opacity: 1;
                transform: translate3d(0, 0, 0) scale(1);
            }
        }

        .finale-word.show {
            animation: finaleWordIn 860ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Reduce motion */
        @media (prefers-reduced-motion: reduce) {
            body { animation: none !important; }
            .floating-heart { animation: none !important; }
            .fade-in, .success-glow, .pulse-heart, .shake { animation: none !important; }
            .tutorial-tooltip { transition: none !important; }
            #finaleScreen, .fade-out { transition: none !important; }

            .finale-word {
                opacity: 1 !important;
                transform: none !important;
                animation: none !important;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 relative overflow-hidden" onclick="hideHelpTooltip(true)">

    <!-- Динамический фон с сердечками -->
    <div id="bgHearts" class="absolute inset-0 overflow-hidden"></div>

    <!-- Экран с подсказкой и вводом кода -->
    <div id="hintScreen" class="glass rounded-3xl p-8 md:p-12 max-w-lg w-full text-center fade-in relative z-10">

        <!-- Иконка-инструкция (верхний левый угол) + тултип (первый вход) -->
        <div class="absolute top-4 left-4 z-20">
            <div class="relative">
                <button id="helpBtn" type="button"
                        onclick="openInstruction()"
                        class="brand-chip w-10 h-10 rounded-full inline-flex items-center justify-center"
                        aria-label="Как ввести код?"
                        title="Как ввести код?">
                    <span class="material-symbols-rounded text-[20px]">help</span>
                </button>

                <div id="helpTooltip" class="tutorial-tooltip tt-hidden hidden" role="tooltip" aria-hidden="true" onclick="dismissHelpTooltip(event)">
                    Как ввести код?
                </div>
            </div>
        </div>

        <div class="mb-5">
            <div class="hero-heart-stack mb-3">
                <span class="material-symbols-rounded ms-fill hero-heart heart-fill" aria-hidden="true">favorite</span>
                <span class="material-symbols-rounded ms-outline hero-heart heart-outline" aria-hidden="true">favorite</span>
            </div>
            <h1 id="hintTitle" class="text-3xl md:text-4xl font-semibold text-love mb-2 tracking-tight">Подсказка #1</h1>
            <p id="hintText" class="text-love-light/90 text-lg leading-relaxed">
                Рядом с мелодией.
            </p>
        </div>

        <div class="mb-3">
            <div class="flex justify-center gap-3 md:gap-4 mb-2" id="codeInputs">
                <input type="text"
                       id="code1"
                       maxlength="2"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       placeholder="00"
                       class="glass-input w-16 h-16 md:w-20 md:h-20 rounded-2xl text-center text-2xl font-medium text-love placeholder-pink-300/50">
                <input type="text"
                       id="code2"
                       maxlength="2"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       placeholder="00"
                       class="glass-input w-16 h-16 md:w-20 md:h-20 rounded-2xl text-center text-2xl font-medium text-love placeholder-pink-300/50">
                <input type="text"
                       id="code3"
                       maxlength="2"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       placeholder="00"
                       class="glass-input w-16 h-16 md:w-20 md:h-20 rounded-2xl text-center text-2xl font-medium text-love placeholder-pink-300/50">
            </div>
            <p id="errorMsg" class="text-rose-500 text-sm h-5 transition-opacity"></p>
        </div>

        <button onclick="checkCode()"
                class="glass-btn px-10 py-4 rounded-2xl font-semibold w-full shadow-lg flex items-center justify-center mx-auto text-lg">
            Проверить код
        </button>
    </div>

    <!-- Финал -->
    <div id="finaleScreen" class="fixed inset-0 hidden z-[60] flex items-center justify-center p-6" aria-hidden="true">
        <div class="absolute inset-0 bg-white/25"></div>
        <div class="relative z-10 text-center">
            <div class="finale-word text-love font-semibold" data-word="0">Я</div>
            <div class="finale-word text-love font-semibold" data-word="1">Тебя</div>
            <div class="finale-word text-love font-semibold" data-word="2">Люблю</div>
        </div>
    </div>

    <!-- Модальное окно: инструкция -->
    <div id="instructionModal" class="fixed inset-0 hidden z-50" aria-hidden="true">
        <div class="absolute inset-0 bg-black/20" onclick="closeInstruction()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass rounded-3xl p-6 md:p-8 max-w-lg w-full text-left">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="material-symbols-rounded">help</span>
                            <h2 class="text-love text-xl font-semibold">Как ввести код</h2>
                        </div>
                    </div>
                    <button type="button" onclick="closeInstruction()" class="brand-chip w-10 h-10 rounded-full inline-flex items-center justify-center" aria-label="Закрыть">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>

                <div class="glass rounded-2xl p-5 border border-pink-200/50">
                    <ol class="list-decimal pl-5 space-y-2 text-love-light/90 text-sm leading-relaxed">
                        <li>Найди подарок по подсказке.</li>
                        <li>На нём (или рядом) найди 3 стикера <span class="font-semibold">Love is</span>, внизу справа на каждом есть цифры.</li>
                        <li>Введи цифры по порядку от меньших к большим (например: <span class="font-semibold">23 67 98</span>).</li>
                        <li>Если ошибся — просто введи заново.</li>
                    </ol>
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="button" onclick="closeInstruction()" class="glass-btn px-6 py-3 rounded-2xl font-semibold">Понятно</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Экран успеха -->
    <div id="successScreen" class="glass rounded-3xl p-8 md:p-12 max-w-lg w-full text-center hidden relative z-10">


        <div class="mb-8">
            <div class="hero-heart-stack mb-5 pulse-heart">
                <span class="material-symbols-rounded ms-fill hero-heart heart-fill" aria-hidden="true">favorite</span>
                <span class="material-symbols-rounded ms-outline hero-heart heart-outline" aria-hidden="true">favorite</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-semibold text-love mb-4 tracking-tight">Чудесно!</h1>
            <div class="glass rounded-2xl p-6 mb-6 border border-pink-200/50">
                <div class="flex items-center justify-center gap-2 mb-3">
                    <span class="material-symbols-rounded text-2xl">location_on</span>
                    <span class="text-love font-medium">Подсказка #2</span>
                </div>
                <p class="text-love-light/90 text-lg leading-relaxed">
                    Там, куда редко падает свет и не заглядывает швабра.
                </p>
            </div>
        </div>

        <button onclick="resetQuest()"
                class="glass-btn px-8 py-3 rounded-2xl font-medium shadow-lg flex items-center justify-center gap-2 mx-auto">
            <span class="material-symbols-rounded text-2xl" style="color: white;">replay</span>
            Начать сначала
        </button>
    </div>

    <script>
        // Шаги квеста: подсказка + код для перехода к следующей
        const steps = [
            { title: 'Подсказка #1', text: 'Рядом с мелодией.', code: ['32', '37', '57'] },
            { title: 'Подсказка #2', text: 'В тени шкафа.', code: ['13', '26', '50'] },
            { title: 'Подсказка #3', text: 'Где-то на столе.', code: ['17', '39', '51'] },
            { title: 'Подсказка #4', text: 'Очень холодно.', code: ['11', '52', '96'] },
            { title: 'Подсказка #5', text: 'Сверху видно лучше.', code: ['21', '59', '62'] },
            { title: 'Подсказка #6', text: 'Треугольная дверь.', code: ['20', '67', '74'] },
            { title: 'Подсказка #7', text: 'Ооочень горячо', code: ['15', '42', '79'] }
        ];

        const PROGRESS_KEY = 'loveQuest_progress_v2';

        let currentHintIndex = 0;

        function loadProgress() {
            try {
                const raw = localStorage.getItem(PROGRESS_KEY);
                if (!raw) return { step: 0, finale: false };
                const data = JSON.parse(raw);
                const step = Number.isFinite(data?.step) ? data.step : 0;
                const finale = !!data?.finale;
                return {
                    step: Math.min(Math.max(step, 0), steps.length - 1),
                    finale
                };
            } catch (e) {
                return { step: 0, finale: false };
            }
        }

        function saveProgress({ step = currentHintIndex, finale = false } = {}) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify({ step, finale }));
            } catch (e) {}
        }

        function clearProgress() {
            try { localStorage.removeItem(PROGRESS_KEY); } catch (e) {}
        }

        // Генерация фоновых сердечек
        function createHearts(count = 36) {
            const root = document.getElementById('bgHearts');
            if (!root) return;

            root.innerHTML = '';

            const heartSVG = (size) => `
                <svg class="floating-heart" width="${size}" height="${size}" viewBox="0 0 24 24" aria-hidden="true">
                    <path class="heart-path" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            `.trim();

            const rand = (min, max) => Math.random() * (max - min) + min;

            for (let i = 0; i < count; i++) {
                const size = Math.round(rand(12, 44));
                const wrapper = document.createElement('div');
                wrapper.innerHTML = heartSVG(size);

                const svg = wrapper.firstElementChild;
                const top = rand(-5, 95);
                const left = rand(-5, 95);
                const delay = rand(0, 6).toFixed(2);
                const duration = rand(7, 13).toFixed(2);
                const opacity = rand(0.06, 0.16).toFixed(2);
                const rotate = rand(-14, 14).toFixed(1);

                svg.style.top = `${top}%`;
                svg.style.left = `${left}%`;
                svg.style.opacity = opacity;
                svg.style.animationDelay = `${delay}s`;
                svg.style.animationDuration = `${duration}s`;
                svg.style.setProperty('--r', `${rotate}deg`);

                root.appendChild(svg);
            }
        }

        // Автофокус на следующее поле
        document.querySelectorAll('#codeInputs input').forEach((input, index, inputs) => {
            input.addEventListener('input', (e) => {
                // Оставляем только цифры
                e.target.value = e.target.value.replace(/\D/g, '');

                // Переход к следующему полю
                if (e.target.value.length === 2 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }

                // Скрываем ошибку при вводе
                document.getElementById('errorMsg').textContent = '';
            });

            // Переход назад при удалении
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    inputs[index - 1].focus();
                }

                // Проверка по Enter
                if (e.key === 'Enter') {
                    checkCode();
                }
            });
        });

        let finaleRunning = false;

        function startFinale() {
            if (finaleRunning) return;
            finaleRunning = true;

            // сохраняем, что квест завершён
            saveProgress({ step: steps.length - 1, finale: true });

            hideHelpTooltip(true);
            closeInstruction();

            const hintScreen = document.getElementById('hintScreen');
            const bg = document.getElementById('bgHearts');
            const finale = document.getElementById('finaleScreen');
            const errorMsg = document.getElementById('errorMsg');
            if (errorMsg) errorMsg.textContent = '';

            // Плавно убираем основной интерфейс
            hintScreen?.classList.add('fade-out');
            if (bg) bg.style.opacity = '0';

            // Показываем финал поверх
            window.setTimeout(() => {
                if (!finale) return;
                finale.classList.remove('hidden');
                finale.setAttribute('aria-hidden', 'false');
                requestAnimationFrame(() => finale.classList.add('finale-visible'));

                const words = Array.from(finale.querySelectorAll('.finale-word'));

                // Сбрасываем состояние/анимацию (чтобы корректно проигрывалось при повторном запуске)
                words.forEach(w => {
                    w.classList.remove('show');
                    // reset animation
                    w.style.animation = 'none';
                    // force reflow
                    void w.offsetHeight;
                    w.style.animation = '';
                });

                // Последовательное появление
                const delays = [180, 980, 1780];
                words.forEach((w, i) => {
                    window.setTimeout(() => w.classList.add('show'), delays[i]);
                });
            }, 340);
        }

        function checkCode() {
            const code1 = document.getElementById('code1').value;
            const code2 = document.getElementById('code2').value;
            const code3 = document.getElementById('code3').value;

            const enteredCode = [code1, code2, code3];
            const codeInputsContainer = document.getElementById('codeInputs');
            const errorMsg = document.getElementById('errorMsg');

            // Проверка на заполненность
            if (!code1 || !code2 || !code3) {
                errorMsg.textContent = 'Заполни все поля';
                codeInputsContainer.classList.add('shake');
                setTimeout(() => codeInputsContainer.classList.remove('shake'), 500);
                return;
            }

            const correctCode = steps[currentHintIndex]?.code || [];

            // Проверка кода
            if (enteredCode.every((val, i) => val === correctCode[i])) {
                const hintScreen = document.getElementById('hintScreen');

                // Последний шаг → финал
                if (currentHintIndex >= steps.length - 1) {
                    startFinale();
                    return;
                }

                // Переход на следующую подсказку (без смены экрана)
                currentHintIndex += 1;
                applyHint(currentHintIndex);
                saveProgress({ step: currentHintIndex, finale: false });

                hintScreen.classList.add('success-glow');
                setTimeout(() => hintScreen.classList.remove('success-glow'), 900);

                // Очистка полей
                document.getElementById('code1').value = '';
                document.getElementById('code2').value = '';
                document.getElementById('code3').value = '';
                document.getElementById('code1').focus();
                errorMsg.textContent = '';
            } else {
                errorMsg.textContent = 'Неверный код. Попробуй снова';
                codeInputsContainer.classList.add('shake');
                setTimeout(() => codeInputsContainer.classList.remove('shake'), 500);

                // Очистка полей
                document.getElementById('code1').value = '';
                document.getElementById('code2').value = '';
                document.getElementById('code3').value = '';
                document.getElementById('code1').focus();
            }
        }

        function resetQuest() {
            const hintScreen = document.getElementById('hintScreen');
            const bg = document.getElementById('bgHearts');
            const finale = document.getElementById('finaleScreen');

            clearProgress();

            // Закрываем финал (если открыт)
            if (finale && !finale.classList.contains('hidden')) {
                finale.classList.remove('finale-visible');
                finale.setAttribute('aria-hidden', 'true');
                window.setTimeout(() => {
                    finale.classList.add('hidden');
                }, 420);
            }

            finaleRunning = false;

            if (bg) bg.style.opacity = '';
            hintScreen?.classList.remove('fade-out');

            currentHintIndex = 0;
            applyHint(currentHintIndex);
            saveProgress({ step: currentHintIndex, finale: false });

            // Очистка полей
            document.getElementById('code1').value = '';
            document.getElementById('code2').value = '';
            document.getElementById('code3').value = '';
            document.getElementById('errorMsg').textContent = '';

            hintScreen?.classList.remove('success-glow');

            setTimeout(() => document.getElementById('code1').focus(), 50);
        }

        const HELP_TOOLTIP_KEY = 'loveQuest_helpTooltipSeen_v1';
        const HELP_TOOLTIP_TRANSITION_MS = 260;

        function showHelpTooltipOnce() {
            const tooltip = document.getElementById('helpTooltip');
            const btn = document.getElementById('helpBtn');
            if (!tooltip || !btn) return;

            const alreadySeen = localStorage.getItem(HELP_TOOLTIP_KEY) === '1';
            if (alreadySeen) return;

            tooltip.classList.remove('hidden');
            tooltip.classList.remove('tt-visible');
            tooltip.classList.add('tt-hidden');
            tooltip.setAttribute('aria-hidden', 'false');

            // Плавное появление
            requestAnimationFrame(() => {
                tooltip.classList.remove('tt-hidden');
                tooltip.classList.add('tt-visible');
            });

            // Автоскрытие через несколько секунд
            window.setTimeout(() => {
                hideHelpTooltip(true);
            }, 5500);
        }

        function hideHelpTooltip(markSeen = false) {
            const tooltip = document.getElementById('helpTooltip');
            if (!tooltip) return;

            tooltip.classList.remove('tt-visible');
            tooltip.classList.add('tt-hidden');
            tooltip.setAttribute('aria-hidden', 'true');

            window.setTimeout(() => {
                tooltip.classList.add('hidden');
            }, HELP_TOOLTIP_TRANSITION_MS);

            if (markSeen) {
                try { localStorage.setItem(HELP_TOOLTIP_KEY, '1'); } catch (e) {}
            }
        }

        function dismissHelpTooltip(e) {
            // Позволяет закрыть по клику на сам тултип
            e.preventDefault();
            e.stopPropagation();
            hideHelpTooltip(true);
        }

        function applyHint(index) {
            const titleEl = document.getElementById('hintTitle');
            const textEl = document.getElementById('hintText');
            if (!titleEl || !textEl) return;

            const h = steps[index] || steps[0];
            titleEl.textContent = h.title;
            textEl.textContent = h.text;
        }

        function getHeartsCount() {
            // меньше на телефонах для плавности
            return window.matchMedia('(max-width: 640px)').matches ? 28 : 42;
        }

        window.onload = () => {
            createHearts(getHeartsCount());

            const progress = loadProgress();
            currentHintIndex = progress.step;
            applyHint(currentHintIndex);

            // Если уже был финал — сразу показываем финальную сцену
            if (progress.finale) {
                startFinale();
                return;
            }

            document.getElementById('code1').focus();
            showHelpTooltipOnce();

            // Убираем fade-in после первого появления, чтобы он не перезапускался при смене подсказок
            const hintScreen = document.getElementById('hintScreen');
            window.setTimeout(() => {
                hintScreen?.classList.remove('fade-in');
            }, 650);
        };

        function openInstruction() {
            hideHelpTooltip(true);
            const modal = document.getElementById('instructionModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeInstruction() {
            const modal = document.getElementById('instructionModal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeInstruction();
                hideHelpTooltip(true);
            }
        });

        // Resize handling (debounced) to avoid jank on mobile (address bar triggers resize)
        let resizeTimer = null;
        let lastW = window.innerWidth;
        let lastIsMobile = window.matchMedia('(max-width: 640px)').matches;

        window.addEventListener('resize', () => {
            if (resizeTimer) window.clearTimeout(resizeTimer);

            resizeTimer = window.setTimeout(() => {
                const w = window.innerWidth;
                const isMobile = window.matchMedia('(max-width: 640px)').matches;

                const breakpointChanged = isMobile !== lastIsMobile;
                const widthChangedEnough = Math.abs(w - lastW) > 80;

                if (breakpointChanged || widthChangedEnough) {
                    createHearts(getHeartsCount());
                    lastW = w;
                    lastIsMobile = isMobile;
                }
            }, 180);
        });
    </script>
</body>
</html>
